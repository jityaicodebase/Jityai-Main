# JityAI Database Documentation & Data Flow Architecture
**Version:** 2.0.0
**Date:** 2026-02-04
**Classification:** Technical Architecture

---

## 1. Executive Summary: The Three-Layer Storage Strategy
The database is architected into three distinct layers to ensure **Data Integrity**, **High Performance**, and **Auditability**. It does not treat "product identity" and "product physical inventory" as the same thing.

### Layer 1: Identity Layer (Immutable)
*   **Purpose**: Defines *what* a product is. 
*   **Behavior**: Long-lived, rarely changes. 
*   **Table**: `store_sku_registry`

### Layer 2: State Layer (Transient)
*   **Purpose**: Defines *how much* stock we have right now.
*   **Behavior**: High frequency updates (real-time).
*   **Table**: `onboarding_handoff`, `v_latest_inventory` (View)

### Layer 3: Intelligence Layer (Analytical)
*   **Purpose**: Defines *what we should do* about it.
*   **Behavior**: Generated by AI agents, immutable audit trail of decisions.
*   **Table**: `inventory_recommendations`

---

## 2. Event Data Flow & Priority

### Scenario A: New Store Onboarding (Priority: CRITICAL)
**Flow:** `Excel Upload` -> `OnboardingOrchestrator` -> `Identity Layer` -> `State Layer`

1.  **Raw Ingestion**: User uploads CSV. System saves raw record to `raw_upload_archive` (Audit).
2.  **Identity Creation**: 
    *   System checks `store_sku_registry`.
    *   If SKU does not exist, it creates a new "Golden Record".
    *   **Priority**: High. This blocks all other operations for this SKU.
3.  **State Snapshot**: 
    *   System inserts quantity/price into `onboarding_handoff`.
    *   This is the "Genesis Block" for that SKU's inventory history.

### Scenario B: Daily Inventory Sync (Priority: HIGH)
**Flow:** `Sync Agent` -> `State Layer` -> `Intelligence Layer`

1.  **Ingestion**: POS system sends delta CSV.
2.  **State Update**: New rows inserted into `onboarding_handoff` (Partitioned by batch).
3.  **Trigger**: `MasterOrchestrator` detects successful sync.
4.  **Action**: Triggers `STOCK_UPDATED` event.

### Scenario C: AI Analysis Run (Priority: MEDIUM - Async)
**Flow:** `STOCK_UPDATED Event` -> `InventoryAIAgent` -> `Intelligence Layer`

1.  **Trigger**: Received `STOCK_UPDATED` event.
2.  **Fetch**: Agent pulls `v_latest_inventory` (View combining Identity + State).
3.  **Compute**: Calculates ADS, Safety Stock, Risk State.
4.  **Decision**: Generates `BUY_MORE` or `MONITOR`.
5.  **Persist**: Saves specific recommendation to `inventory_recommendations`.

---

## 3. Detailed Schema Specification

### 3.1 `store_sku_registry` (The "Gold Record")
**Role**: The single source of truth for product definitions.

| Field | Type | Priority | Description |
| :--- | :--- | :--- | :--- |
| **`store_id`** | VARCHAR | PK | Composite Primary Key |
| **`store_item_id`** | VARCHAR | PK | Composite Primary Key |
| `normalized_product_name` | VARCHAR | Critical | The cleaned, human-readable name (e.g., "Maggi Noodles 70g") |
| `master_category_id` | VARCHAR | Critical | Link to Global Master Catalog (for Federated Learning) |
| `mapping_confidence` | DECIMAL | High | 0.0-1.0 score. If < 0.65, flagged for review. |
| `mapping_method` | VARCHAR | Info | How it was mapped (Fuzzy, LLM, Manual) |
| `status` | ENUM | High | `active`, `deprecated`, `needs_review` |

### 3.2 `onboarding_handoff` (The "Inventory Log")
**Role**: An append-only log of inventory states. We never "update" inventory; we only "insert new states".

| Field | Type | Priority | Description |
| :--- | :--- | :--- | :--- |
| `store_id`, `store_item_id` | VARCHAR | FK | Links to Identity Layer |
| `batch_id` | UUID | FK | Links to the specific upload event |
| `quantity_on_hand` | DECIMAL | Critical | Stock level at this specific moment |
| `selling_price` | DECIMAL | High | Price at this moment |
| `cost_price` | DECIMAL | High | Cost at this moment |
| `as_of_date` | TIMESTAMP | Critical | When this snapshot was valid |

### 3.3 `inventory_recommendations` (The "Brain Output")
**Role**: Stores the AI's advice. Used for dashboard alerts and "Realized Outcome" tracking.

| Field | Type | Priority | Description |
| :--- | :--- | :--- | :--- |
| `recommendation_id` | UUID | PK | Unique ID |
| `recommendation_type` | ENUM | Critical | `BUY_MORE`, `BUY_LESS`, `MONITOR` |
| `risk_state` | ENUM | High | `CRITICAL`, `RISK`, `WATCH`, `SAFE` |
| `recommended_order_quantity`| INT | High | Exact purchase suggestion |
| `days_of_cover` | DECIMAL | High | `CurrentStock / Weighted ADS` |
| `feedback_status` | ENUM | Critical | `PENDING`, `ACCEPTED`, `IGNORED`. Used for RL. |
| `realized_outcome` | VARCHAR | Audit | Did we make/lose money? Filled 7 days later. |

---

## 4. Key Database Views

### `v_latest_inventory`
**Purpose**: The most frequent query. Instantly gives the "Now" state of every product.
```sql
SELECT 
    r.store_id, 
    r.store_item_id, 
    r.normalized_product_name,
    h.quantity_on_hand, -- Most recent value
    h.selling_price
FROM store_sku_registry r
LEFT JOIN LATERAL (
    SELECT * FROM onboarding_handoff h 
    WHERE h.store_id = r.store_id AND h.store_item_id = r.store_item_id
    ORDER BY h.as_of_date DESC LIMIT 1
) h ON TRUE;
```

---

## 5. Priorities & Constraints
1.  **Foreign Key Constraint**: You cannot insert inventory (`onboarding_handoff`) for a product that doesn't exist in `store_sku_registry`.
    *   *Why?* Prevents "Ghost Inventory" data quality issues.
2.  **Feedback Lock**: You cannot modify an `inventory_recommendation` once `processed_at` is set (Audit trail).
3.  **Unique Identity**: A Store + ItemID combination is unique. If a store uploads the same ID again with a better name, we `UPDATE` the registry, we don't duplicate.

